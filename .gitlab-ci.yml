image: ubuntu:22.04

stages:
  - deploy
  - test
  - destroy

# ----------------------------------------------------
# GLOBAL SETUP (Runs before every job)
# ----------------------------------------------------
before_script:
  - apt-get update -y
  - apt-get install -y curl python3 python3-pip unzip wget git
  - chmod +x scripts/*.sh

  # Install Terraform 1.14.0
  - TERRAFORM_VERSION=1.14.0
  - wget https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip
  - unzip -o terraform_${TERRAFORM_VERSION}_linux_amd64.zip -d /usr/local/bin/
  - terraform -version

  # Install AWS CLI
  - pip3 install awscli --upgrade
  - aws --version

# ----------------------------------------------------
# DEPLOY
# ----------------------------------------------------
deploy:
  stage: deploy
  script:
    - echo "ðŸš€ Running deploy script..."
    - bash ./scripts/deploy.sh
  artifacts:
    paths:
      - terraform/        # âœ” Save entire terraform folder
    expire_in: 1 hour
  only:
    - main

# ----------------------------------------------------
# TEST
# ----------------------------------------------------
test:
  stage: test
  needs:
    - job: deploy
      artifacts: true
  script:
    - echo "ðŸ§ª Running test script..."
    - bash ./scripts/test.sh
  only:
    - main

# ----------------------------------------------------
# DESTROY
# ----------------------------------------------------
destroy:
  stage: destroy
  needs:
    - job: deploy
      artifacts: true
  script:
    - echo "ðŸ’£ Running destroy script..."
    - bash ./scripts/destroy.sh
  when: manual
  only:
    - main


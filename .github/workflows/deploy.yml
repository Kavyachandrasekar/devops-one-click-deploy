name: DevOps One-Click Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Manual trigger for destroy

env:
  AWS_REGION: ap-south-1
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:
  # -----------------------------
  # DEPLOY
  # -----------------------------
  deploy:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl python3 python3-pip unzip wget git
          chmod +x ./scripts/*.sh
          # Terraform 1.14.0
          TERRAFORM_VERSION=1.14.0
          wget https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip
          unzip -o terraform_${TERRAFORM_VERSION}_linux_amd64.zip -d /usr/local/bin/
          terraform -version
          # AWS CLI
          pip3 install awscli --upgrade
          aws --version

      - name: Run Deploy Script
        run: bash ./scripts/deploy.sh

      - name: Upload Terraform Folder
        uses: actions/upload-artifact@v4
        with:
          name: terraform-folder
          path: terraform/

  # -----------------------------
  # TEST
  # -----------------------------
  test:
    needs: deploy
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Download Terraform Folder
        uses: actions/download-artifact@v3
        with:
          name: terraform-folder
          path: terraform/

      - name: Run Test Script
        run: bash ./scripts/test.sh

  # -----------------------------
  # DESTROY (manual trigger)
  # -----------------------------
  destroy:
    needs: deploy
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Download Terraform Folder
        uses: actions/download-artifact@v3
        with:
          name: terraform-folder
          path: terraform/

      - name: Run Destroy Script
        run: bash ./scripts/destroy.sh
